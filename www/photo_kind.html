<!--
  data/projects/專案名稱 最外層的 jpg 要移動到 data/projects/專案名稱/my_dataset 底下

-->
<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <title>我的 yolo 訓練機</title>
    <script src="/www/js/jquery.min.js"></script>
    <script src="/www/js/myphp.js"></script>
    <script src="/www/js/mybox.js"></script>
    <script src="/www/js/include.js"></script>
    <link rel="stylesheet" href="/www/css/reset.css" />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="/www/css/style.css" />
    <script src="/www/js/jquery-image-lazy-loading/js/jquery.lazyload.min.js"></script>
    <style>
        .thetable {
            width: 100%;
        }

            .thetable thead th[field='fake_img'] {
                width: 650px;
            }

            .thetable tbody td[field='fake_img'] img {
                margin-left: auto;
                margin-right: auto;
            }

            .thetable tbody td[field='fake_options'] {
                /* 可自動斷行 */
                white-space: normal;
            }


        a[reqc='btnKind'] {
            margin: 5px;
        }
    </style>
</head>
<body class="container mt-5">
    <h4>請依照片點選分類項目，待處理張數：<span reqc="left_photo_counts">--</span></h4>
    <hr class="my-4" style="border-color: red;" />
    <div id="divMain">
        <!-- 開始列照片 -->
    </div>
</body>
</html>
<script>
    var GETS = getGET();
    var PROJECT_NAME = GETS["project_name"];
    console.log(PROJECT_NAME);
    // 取得照片分類
    window['kind_lists'] = [];

    function countLeftPhoto() {
        var counts = $(".thetable tbody tr").length;
        $("span[reqc='left_photo_counts']").html(counts + " 張");
    }

    myAjax_async_json("/api?mode=getKindList", { "project_name": PROJECT_NAME }, function (jd) {
        if (jd['status'] == 'OK') {
            for (var kind_name in jd['data']) {
                window['kind_lists'].push(kind_name);
            }

            //接下來取出照片
            myAjax_async_json("/api?mode=getPhotoList", { "project_name": PROJECT_NAME }, function (jd) {
                if (jd['status'] == 'OK') {
                    // 待分類處理張數
                    $("span[reqc='left_photo_counts']").html(jd['data'].length + " 張");
                    jd['data'].map(function (v) {
                        v['fake_img'] = `
                        <img
                            reqc='theimg'
                            src="/www/js/jquery-image-lazy-loading/images/grey.gif"
                            data-original="/data/projects/${PROJECT_NAME}/${v['photo_name']}"
                            style="width: 640px;"
                            req_bn="${v['photo_name']}"
                        />`;
                        // 然後分類的按鈕
                        v['fake_options'] = "";
                        for (var i = 0; i < kind_lists.length; i++) {
                            v['fake_options'] += `<a href="javascript:;" class="btn btn-primary" reqc="btnKind" req_bn="${v['photo_name']}" req_kind="${kind_lists[i]}">${kind_lists[i]}</a>`;
                        }
                        // 加一個刪除按鈕在右下角落
                        v['fake_options'] += `<br><br><div align='right'><a href="javascript:;" class="btn btn-danger" reqc="btnDel" req_bn="${v['photo_name']}">刪除</a></div>`;
                    });
                    var table = print_table(jd['data'], "fake_img,fake_options", "照片,設定分類", "thetable");
                    $("#divMain").html(table);
                    $(".thetable tbody td img[reqc='theimg']").lazyload();

                    // 本身的 iframe 改高度
                    var iframe = window.frameElement;
                    iframe.style.height = document.body.scrollHeight + 'px';

                    // 點分類
                    $("a[reqc='btnKind']").off().click(function () {
                        var photo_name = $(this).attr("req_bn");
                        var kind_name = $(this).attr("req_kind");
                        myAjax_async_json("/api?mode=setPhotoToKind", { "project_name": PROJECT_NAME, "photo_name": photo_name, "kind_name": kind_name }, function (jd) {
                            if (jd['status'] == 'OK') {
                                smallComment("設定成功...", 2000, false, {});
                                $(`a[req_bn='${photo_name}']`).closest("tr").fadeOut("fast").delay(10, function () {
                                    $(this).remove();
                                    // 重算待處理筆數
                                    countLeftPhoto();
                                });
                            }
                            else {
                                smallComment("設定失敗...", 2000, false, {});
                            }
                        });
                    });


                    // 點刪除
                    $("a[reqc='btnDel']").off().click(function () {
                        var photo_name = $(this).attr("req_bn");
                        //if (confirm("確定要刪除嗎？")) {
                        {
                            myAjax_async_json("/api?mode=delPhoto", { "project_name": PROJECT_NAME, "photo_name": photo_name }, function (jd) {
                                if (jd['status'] == 'OK') {
                                    smallComment("刪除成功...", 2000, false, {});
                                    //location.reload();
                                    $(`a[req_bn='${photo_name}']`).closest("tr").fadeOut("fast").delay(10, function () {
                                        $(this).remove();
                                        // 重算待處理筆數
                                        countLeftPhoto();
                                    });
                                }
                                else {
                                    smallComment("刪除失敗...", 2000, false, {});
                                }
                            });
                        }
                    });
                }
            });
        }
    });



</script>
